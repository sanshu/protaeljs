/*! protael 0.1.0
2015-07-14 */
function ProtaelBrowser(a,b,c,d,e){Protael(a,b,e).draw()}Snap.plugin(function(a,b){"use strict";var c=b.prototype;c.toFront=function(){return this.appendTo(this.paper)},c.toBack=function(){return this.prependTo(this.paper)},c.hide=function(){return this.attr({visibility:"hidden",display:"none"})},c.show=function(){return this.attr({visibility:"visible",display:"inline"})},c.dragVertical=function(b,c,d,e,f,g){function h(h,i,j){(h.originalEvent||h).preventDefault(),this._drag.x=i,this._drag.y=j,this._drag.id=h.identifier,!drag.length&&a.mousemove(dragMove).mouseup(dragUp),drag.push({el:this,move_scope:e,start_scope:f,end_scope:g}),c&&eve.on("snap.drag.start."+this.id,c),b&&eve.on("snap.drag.move."+this.id,b),d&&eve.on("snap.drag.end."+this.id,d),eve("snap.drag.start."+this.id,f||e||this,i,j,h)}if(!arguments.length){var i;return this.drag(function(a,b){this.attr({transform:i+(i?"T":"t")+[0,b]})},function(){i=this.transform().local})}return this._drag={},draggable.push({el:this,start:h}),this.mousedown(h),this}});var Protael=function(){"use strict";function a(a,b,c){b.a=b.append,b.a("Zoom:"),b.a($('<div class="protael_zoomslider"></div>').slider({value:a.currentScale(),min:.5,max:15,step:.02,slide:function(b,c){a.setZoom(c.value)}})),b.a($("<button>Zoom to fit</button>").button({text:!1,icons:{primary:"ui-icon ui-icon-arrow-4-diag"}}).click(function(){a.zoomToFit()})),b.a($("<button>Zoom to selection</button>").button({text:!1,icons:{primary:"ui-icon ui-icon-arrowthick-2-e-w"}}).click(function(){a.zoomToSelection()})),b.a('&nbsp;&VerticalLine;&nbsp;Selection: <input type="text" class="protael_selection_inp" readonly/>'),b.a($('<button id="export">Export</button>').button({text:!1,icons:{primary:"ui-icon-disk"}}).click(function(){$("#xarea").text(a.getConstruct()),$("#xdialog").dialog("open")})),$("#xdialog").dialog({modal:!0,autoOpen:!1,buttons:{Ok:function(){$(this).dialog("close")}}}),b.a($("<button>Reset selection</button>").button({text:!1,icons:{primary:"ui-icon-refresh"}}).click(function(){a.clearSelection()})),b.a("&nbsp;&VerticalLine;&nbsp;Coloring:"),b.a($("<select><option>Original</option><option>Clustal</option><option>Lesk</option><option>Cinema</option><option>MAEditor</option><option>ALI</option><option>None</option></select>").change(function(){a.setColoringScheme($(this).val())})),c||b.hide(),b.a("&nbsp;&VerticalLine;&nbsp;"),b.a($('<input type="checkbox" id="chkTooltip" checked="true"><label for="chkTooltip">Cursor tooltips</label>').change(function(){a.setShowCursorTooltips($("#chkTooltip").is(":checked"))})),b.a("&nbsp;&VerticalLine;&nbsp;"),b.a($("<button>Export SVG</button>").button({text:!1,icons:{primary:"ui-icon ui-icon-image"}}).click(function(){a.saveAsSVG()}))}function b(e,f,h){if(!(this instanceof b))return new b(e,f,h);var i=navigator.appVersion,j=this,k='<div class="ui-widget-content protael_resizable"></div>',l=$(k),m=$('<div class="ui-widget-header ui-corner-all protael_toolbar"></div>'),n='<div width="100%" height="100%" class="protael_svg"><div><div class="protael_slider"></div></div><svg id="'+f+'_svgcanvas" width="100%" height="100%" preserveAspectRatio="xMinYMin meet"><desc>Protael '+b.version+"</desc></svg></div>",o=$(n);$("#"+f).append(l),this.container=f,l.append(m),l.append(o),this.protein=e,d=o.width(),this.controlsEnabled=h,this.controlsEnabled&&$("#"+this.container+" .protael_slider").slider({range:!0,min:1,max:e.sequence.length,values:[1,1],slide:function(a,b){j.setSelection(b.values[0],b.values[1])}}),h&&(l.append('<div id="xdialog" title="Export selection"><textarea id="xarea" cols="40" rows="10"></textarea></div>'),a(this,m,h)),l.append('<div id="propsdialog" title="Properties"></div>'),$("#propsdialog").dialog({modal:!0,autoOpen:!1,width:"auto",buttons:{Ok:function(){$(this).dialog("close")}}}),this.selectedx=[-1,-1],this.svgDiv=$("#"+f+" .protael_svg"),this.selectSlider=$("#"+f+" .protael_slider"),this.selectInput=$("#"+f+" .protael_selection_inp"),this.isChrome=i.indexOf("Chrome")>=0||i.indexOf("Opera")>=0,this.currScale=1,this.currShift=0,this.showCursorTooltips=!0,this.paper=new c(f,o.width(),o.height(),this),this.H=g.calcHeight(this.protein),this.W=this.protein.sequence.length,this.paper.setSize(this.W,this.H),this.paper.axis(this.W,10),l.resizable({stop:function(){j.zoomToFit()}})}function c(a,b,c,d){this.protael=d,this.paper=Snap("#"+a+"_svgcanvas"),this.paper.attr({viewBox:"0 0 "+b+" "+c});var e=this.paper;return this.pLink=e.text(0,0,"Powered by Protael").attr({id:"prref"}),this.pLink.click(function(){window.open("http://proteins.burnham.org:8080/Protael/")}),this.viewSet=Snap.set(),this.textSet=Snap.set(),this.textSet.push(this.pLink),this.overlayFtLabels=Snap.set(),this.createDefs(),this.gAxes=e.g().attr({id:"axes"}),this.gSequences=e.g().attr({id:"seqs"}),this.gFTracks=e.g().attr({id:"ftracks"}),this.gQTracks=e.g().attr({id:"qtracks"}),this.seqChars=e.g().attr({id:"seqChars","font-family":"monospace","font-size":"12px","text-anchor":"start","letter-spacing":"0px"}),this.seqLines=e.g().attr({id:"seqLines"}),this.seqLineCovers=e.g().attr({id:"seqLineCovers",opacity:0}),this.seqBGSet=e.g().attr({id:"seqBGSet",opacity:.7}),this.seqLabelsSet=e.g().attr({"font-size":"9px","text-anchor":"start",id:"seqLabels"}),this}b.version="0.1.0",b.link="http://proteins.burnham.org:8080/Protael/",b.linkText="ProtaelJS";var d,e={mainSeqHeight:55,featureHeight:15,graphHeight:50,graphSpacing:20,space:20},f=function(){function a(a){return a=a.toLowerCase(),i[a]||i.clustal}function b(a,b){b[a]=schemas}var c="orange",d="red",e="blue",f="green",g="magenta",h="grey",i={clustal:{G:c,P:c,S:c,T:c,H:d,K:d,R:d,F:e,W:e,Y:e,I:f,L:f,M:f,V:f},lesk:{G:c,A:c,S:c,T:c,C:f,V:f,I:f,L:f,P:f,F:f,Y:f,M:f,W:f,N:g,Q:g,H:g,D:d,E:d,K:e,R:e},maeditor:{A:"lightgreen",G:"lightgreen",C:f,D:"DarkGreen",E:"DarkGreen ",N:"DarkGreen ",Q:"DarkGreen ",I:e,L:e,M:e,V:e,F:"#C8A2C8",W:"#C8A2C8",Y:"#C8A2C8",H:"DarkBlue ",K:c,R:c,P:"pink",S:d,T:d},cinema:{H:e,K:e,R:e,D:d,E:d,S:f,T:f,N:f,Q:f,F:g,W:g,Y:g,P:"brown",G:"brown",C:"yellow",B:h,Z:h,X:h},ali:{A:h,R:h,N:h,D:h,C:h,E:h,Q:h,G:h,H:h,I:h,L:h,K:h,M:h,F:h,P:h,S:h,T:h,W:h,Y:h,V:h}};return{getCSchema:a,addCSchema:b}}();!function(a){function b(a){var b,c,d=new Array,e=new Array,f=a.length-1,g=new Array,h=new Array,i=new Array,j=new Array;for(g[0]=0,h[0]=2,i[0]=1,j[0]=a[0]+2*a[1],b=1;f-1>b;b++)g[b]=1,h[b]=4,i[b]=1,j[b]=4*a[b]+2*a[b+1];for(g[f-1]=2,h[f-1]=7,i[f-1]=0,j[f-1]=8*a[f-1]+a[f],b=1;f>b;b++)c=g[b]/h[b-1],h[b]=h[b]-c*i[b-1],j[b]=j[b]-c*j[b-1];for(d[f-1]=j[f-1]/h[f-1],b=f-2;b>=0;--b)d[b]=(j[b]-i[b]*d[b+1])/h[b];for(b=0;f-1>b;b++)e[b]=2*a[b+1]-d[b+1];return e[f-1]=.5*(a[f]+d[f-1]),{p1:d,p2:e}}function c(a,b){var c={};a.properties&&Object.keys(a.properties).length&&(c["data-d"]=JSON.stringify(a.properties)),a.dbxrefs&&Object.keys(a.dbxrefs).length&&(c["data-x"]=JSON.stringify(a.dbxrefs)),b.attr(c)}a.setSize=function(a,b){var c=this.paper,d=c.attr("viewBox"),e=(this.pLink.getBBox(),"".concat(b).concat("px"));return d.height=b,c.attr({height:e,width:a,viewBox:d}),this.pLink.attr({x:a-1,y:b}),this},a.getWidth=function(){return this.paper.attr("width")},a.setZoom=function(a){var b=this.protael,c=a/b.currScale,d=this.getWidth();d.indexOf("px")>0&&(d=d.replace(/[^\d.-]/g,""));var e=Math.round(d*c);if(this.setWidth(e),this.viewSet.forEach(function(b){var d=b.attr("x"),e=b.attr("width");if(d)b.attr({x:d*c});else if("line"===b.type){var f=b.attr("x1"),g=b.attr("x2");b.attr({x1:f*c,x2:g*c})}else"path"===b.type&&b.transform("s"+a+" 1 0 0");e&&!isNaN(e)&&b.attr({width:e*c})}),this.textSet.forEach(function(a){var b=a.attr("x");b&&a.attr({x:b*c})}),this.isChrome){var f=this.strechSeq;f.attr({"letter-spacing":"0px"}).hide();var g=f.getBBox().width,h=e-g,i=f.attr("numspaces"),j=h/i+"px",k=f.attr("x");f.attr({x:k*c,"letter-spacing":j}),this.seqChars.attr({"letter-spacing":j})}return b.currScale=a,b.currScale>1?this.seqBGSet.show():this.seqBGSet.hide(),b.currScale>7?this.seqChars.show():this.seqChars.hide(),this.overlayFtLabels.forEach(b.currScale>7?function(a){a.hide()}:function(a){a.show()}),this},a.axis=function(a,b){var c,d,e,f=a/b+1,g=this.protael.H,h=this.paper,i=h.g().attr({id:"axLbls","class":"pl-axeslbl"});for(c=0;f>=c;c++)d=h.line(Math.round(c*b),0,Math.round(c*b),g),c%5===0?(d.attr({"class":"major"}),e=h.text(c*b,8,c*b),this.textSet.push(e),i.add(e)):d.attr({"class":"minor"}),this.gAxes.add(d),this.viewSet.push(d);return this.gAxes.add(i),this.gAxes},a.createDefs=function(){var a=this.paper,b=5,c=8,d=38,e=a.g().attr({id:"gap","stroke-width":2}),f="m 9.943742,1.54515 0,7.665216 C 9,15 8.977801,15 6,18 5.092011,19.329493 0.900884,20.578894 0,22 -0.903141,20.578894 -4.252632,19.379901 -5.160607,18.050408 -7.745849,14.487355 -9.7582132,11.922758 -9.6863207,9.212778 l 0,-7.667628 -5.7594933,0 0,7.665216 c 0.07412,5.544348 3.171965,8.901205 5.6876008,12.525256 2.6545072,3.598566 6.1354302,5.259308 6.0060532,7.136425 L -3.75216,38 4,38 4,28.866878 c -0.129374,-1.874375 3.351556,-3.535283 6.006045,-7.133892 2.518073,-3.62402 5.613376,-6.978272 5.687696,-12.52262 l 0,-7.665216 z";a.path(f).transform("scale(0.3)").attr({id:"glycan"}).toDefs(),f="m 9.943742,1.54515 0,7.665216 c 0.01858,0.678098 -1.8182777,4.537747 -2.31158,4.024493 L -1.548312,3.388971 -5,6.5 6.022199,18 C 5.11421,19.329493 2.03074,20.719454 1.129856,22.14056 0.226715,20.719454 -4.252632,19.379901 -5.160607,18.050408 -7.745849,14.487355 -9.7582132,11.922758 -9.6863207,9.212778 l 0,-7.667628 -5.7594933,0 0,7.665216 c 0.07412,5.544348 3.171965,8.901205 5.6876008,12.525256 2.6545072,3.598566 6.1354302,5.259308 6.0060532,7.136425 L -3.75216,38 4,38 4,28.866878 c -0.129374,-1.874375 3.351556,-3.535283 6.006045,-7.133892 2.518073,-3.62402 5.613376,-6.978272 5.687696,-12.52262 l 0,-7.665216 z",a.path(f).transform("scale(0.3)").attr({id:"oliglycan"}).toDefs(),f="M 9.943742,1.54515 5.757162,5.359859 4,1.625 l -7,0 -2.311321,3.712778 -4.3749997,-3.792628 -5.7594933,0 5.6876008,8.190472 c 2.6545072,3.598566 6.1354302,1.259308 6.0060532,3.136425 L -3.75216,38 4,38 4,12.866878 C 4,11 7.351556,13.331595 10.006045,9.732986 L 15.693741,1.54515 z",a.path(f).transform("scale(0.3) ").attr({id:"unknownglycan"}).toDefs(),a.line(0,0,0,12).attr({id:"stick","stroke-width":2}).toDefs(),e.add(a.line(0,c,0,d-c)),e.add(a.line(-b,0,0,c)),e.add(a.line(b,0,0,c)),e.add(a.line(-b,d,0,d-c)),e.add(a.line(b,d,0,d-c)),e.toDefs()},a.addDef=function(a,b,c){if(this.paper.el("use").attr({"xlink:href":"#"+b}))return void console.log("Marker with the name '"+b+"' already exists!");var d=this.paper.path(a).attr({id:b});c&&d.transform(c),d.toDefs()},a.createUse=function(a,b,c,d){var e=this.paper.el("use").attr({x:b-.5,y:c,"xlink:href":"#"+a}),f=this.paper.rect(b-.75,c,1.5,15).attr({opacity:0}),g=this.paper.g(f,e);return g.attr(d),this.viewSet.push(f),this.viewSet.push(e),g},a.setWidth=function(a){var b,c=this.paper.attr("viewBox");c.width=a+20,b="".concat(a).concat("px"),this.paper.attr({width:b,viewBox:c}),this.protael.selectSlider.length&&this.protael.selectSlider.width(b)},a.proteinSeqBG=function(a,b,c,d,e){e=1*e-1||0;var f=this.protael,g=this,h=this.paper,i="white";setTimeout(function(){var j,k,l=f.currentScale()||1,m=d?9:3,n=i,o=n,p=1,q=[],r=a.length,s=c;for(j=0;r>j;j++)n=b[j]||i,o!==n&&(o!==i&&(k=h.rect((p+e)*l,s,(j-p)*l,m).attr({fill:o,stroke:o}),q.push(k),g.viewSet.push(k)),p=j,o=n);o!==i&&(k=h.rect((p+e)*l,s,(j-p)*l,m).attr({fill:o,stroke:o}),q.push(k),g.viewSet.push(k)),g.seqBGSet.add(q)},10)},a.proteinSequence=function(a,b,d,e){e=e||{},b=b||10;var f,g=this.paper,h=this,i=e.description||e.label||e.id,j=g.g().attr({id:"SG_"+i,title:i||""}),k=e.start-1||0,l=this.protael,m=d?15:3,n=g.line(0,b+m/2,this.protael.W,b+m/2).attr({"class":"pl-seqline"}),o=g.rect(0,b,this.protael.W,10).attr({id:"seq_"+i,title:i||"",opacity:0}),p=a.length;j.add(o,n),e.data=e.data||{},e.clazz&&o.attr({"class":e.clazz}),e.description&&(e.data.Description=e.description),c(e,o),this.seqLineCovers.add(o),this.seqLines.add(n),this.viewSet.push(n,o),d&&(this.isChrome?(this.strechSeq=this.paper.text(k*l.currentScale(),b+8,a.join("")).hide(),f=this.strechSeq.getBBox().width,this.strechSeq.attr({uwidth:f,numspaces:a.length}),this.textSet.push(this.strechSeq),this.seqChars.add(this.strechSeq)):setTimeout(function(){if(d){var c,e,f,i=[];for(c=0;p>c;c++)"."!==a[c]&&(e=(k+c)*l.currentScale(),f=g.text(e,b+8,a[c]),i.push(f),h.textSet.push(f));h.seqChars.add(i)}},10))},a.clearColoring=function(){for(var a in this.seqBGSet)this.viewSet.exclude(this.seqBGSet[a]);this.seqBGSet.clear()},a.setColoringScheme=function(a){if(this.clearColoring(),"none"!==a.toLowerCase()){var b,c,d,e,h,i=this.aliTop,j=this.protael.protein,k=j.alidisplay?!0:!1,l=[],m=j.sequence.toUpperCase().split(""),n=35;if("original"===a.toLowerCase()){if(j.seqcolors)for(b=g.splitData(j.seqcolors.data.toUpperCase()),e=m.length;e--;)l[e]=j.seqcolors.colors[b[e]];else this.setColoringScheme("none");if(this.proteinSeqBG(m,l,n,!0),j.alignments)for(c=0,d=j.alignments.length;d>c;c++){if(h=j.alignments[c],l=[],m=h.sequence.split(""),h.color)for(e=m.length;e--;)l[e]=h.color;else if(h.seqcolors){if(b=g.splitData(h.seqcolors.data.toUpperCase()),h.seqcolors.colors&&Array.isArray(h.seqcolors.colors))for(e=m.length;e--;)l[e]=h.seqcolors.colors[b[e]];else if(j.seqcolors.colors)for(e=m.length;e--;)l[e]=j.seqcolors.colors[b[e]]}else l=g.getColors(m,f.getCSchema(h.CS||"ALI"));this.proteinSeqBG(m,l,i,k,h.start||0,h.label),i+=10,j.alidisplay&&(i+=5)}}else{var o=f.getCSchema(a);if(l=g.getColors(m,o),this.proteinSeqBG(m,l,n,!0),j.alignments)for(var c in j.alignments)m=j.alignments[c].sequence.split(""),l=g.getColors(m,o),this.proteinSeqBG(m,l,i,k,j.alignments[c].start||0),i+=10,j.alidisplay&&(i+=5)}}},a.addColoringScheme=function(a,b){f.addSChema(a,b)},a.featureTrack=function(a,b,d,e,f,g){var h,i,j,k=this.paper,l="pl-ftrack "+(a.clazz||""),m=k.g().attr({id:a.label,"class":l,"font-size":d-8+"px"}),n=a.display||"block",o=a.color||"",p=[],q=0,r=a.features.length;if(this.gFTracks.add(m),p.push(0),e){for(j=0;r>j;j++)if(h=a.features[j]){var s=this.feature(h,h.color||o,n,0,d,m,f,e,g);h.click&&s.click(h.click(h.dbxrefs)),c(h,s)}}else{a.features.sort(function(a,b){return a.start-b.start});for(var t=JSON.parse(JSON.stringify(a.features)),u=0;t.length>0;)if(h=t.shift())if(i=0,h.draw_level=h.draw_level||0,i=h.draw_level*d,-1===$.inArray(i,p)&&p.push(i),h.draw_level!==q&&(u=0),h.start>=u){var s=this.feature(h,h.color||o,n,0+i,d,m,!0,e,g);h.click&&s.click(h.click),c(h,s),u=h.end,q=h.draw_level}else h.draw_level++,t.push(h)}if(a.showLine){var v="block"===n?0:-d/2+2,w=d/2-v;for(var i in p){var x=p[i],y=k.line(0,w+x,this.protael.W,w+x).attr({stroke:"#BBB",fill:"#BBB","stroke-width":"1px",title:a.label||""}).toBack();m.prepend(y),this.viewSet.push(y)}}if(!g){var z=k.text(.1,8,a.label).attr({"class":"pl-ftrack-label"});m.append(z)}return m.transform("translate(0, "+b+")"),m.dragVertical(),q},a.feature=function(a,b,c,d,e,f,g,h,i){var j,k,l,m=a.start-1,n=a.end,o="pl-feature",p=this.paper;return"block"===c?k=p.rect(m,d,n-m,e):"line"===c&&(k=p.rect(m,d+e/2+4,n-m,3)),b&&k.attr({fill:b}),h&&k.attr({opacity:.6}),a.clazz&&(o+=" "+a.clazz,k.attr({"class":a.clazz})),j=p.g().attr({id:a.label||"",title:a.label,fill:b,"class":o}),j.add(k),g&&(l=p.text(.5*m+.5*n,d+e-5,a.label),l.attr({stroke:"none","class":"pl-feature-label"}),j.append(l),this.textSet.push(l),i&&this.overlayFtLabels.push(l)),f.add(j),this.viewSet.push(k),j},a.path=function(a,b,c,d,e,f,g,h){return"L"+a+" "+b+" C"+c+" "+d+" "+e+" "+f+" "+g+" "+h},a.quantTrack=function(a,d,e,f){var h,i,j,k,l,m,n=Array.isArray(a.values)?a.values:g.splitData(a.values),o=a.color||"#F00",p=o,q=Math.max.apply(Math,n),r=Math.min.apply(Math,n),s=-r/(q-r)*100,t="",u=f/(q-r),v="spline",w="column",x="area",y="area-spline",z="line",A=a.type||y,B=this.protael.W,C=this.paper;for(h=n.length;e>=h;h++)n[h]=0;if(Array.isArray(o)&&(1===o.length?p=o[0]:2===o.length?""!==o[1]&&(p=C.gradient("l(0, 1, 0, 0)"+o[0]+":10-"+o[1]+":90")):3===o.length&&(p=""===o[1]?o[0]:C.gradient(""===o[2]?"l(0, 1, 0, 0)"+o[0]+":10-"+o[1]+":90":"l(0, 1, 0, 0)"+o[0]+":10-"+o[1]+":"+s+"-"+o[2]+":90"))),A===x||A===z||A===y||A===v){if(t="M0 "+(f+r*u),A===x||A===z){for(i=0;B>i;i++)k=i,l=f-(n[i]-r)*u,i!==j-1&&(t=t+"L"+k+", "+l);t=t+"L"+B+" "+(f+r*u)+" Z"}else if(A===y||A===v){var D,E,F=new Array,G=new Array;for(h=0;B>h;h++)F[h]=h,G[h]=f-(n[h]-r)*u;for(D=b(F),E=b(G),h=0;B>h;h++)t+=this.path(F[h],G[h],D.p1[h],E.p1[h],D.p2[h],E.p2[h],F[h+1],G[h+1]);t=t+"L"+B+" "+(f+r*u)+" Z"}m=C.path(t).attr({stroke:p,fill:p,"class":"pl-chart-area"}),(A===z||A===v)&&m.attr({"fill-opacity":0,"stroke-width":".1px"})}else if(a.type===w){var H=C.g().attr({stroke:p,fill:"orange","class":"pl-chart-area",opacity:1}),I=f+r*u;for(i=0;B>i;i++){k=i;var J=0;n[i]>=0?(l=(q-n[i])*u,J=n[i]*u):(l=I,J=-n[i]*u);var K=C.rect(k,l,1,J);this.viewSet.push(K),H.add(K)}m=C.rect(0,0,B,f).attr({stroke:p,fill:p,mask:H})}else console.log("Unknown chart type :"+A);var L=C.text(.1,8,a.label).attr({"class":"pl-chart-label"}),M=C.line(0,0,B,0).attr({"class":"pl-chart-top"}),N=C.line(0,q*u,B,q*u).attr({"class":"pl-chart-center"}),O=C.line(0,f,B,f).attr({"class":"pl-chart-bottom"}),P=C.g(m,M,O,N,L).attr({id:"qtrack_"+a.label,"class":"pl-chart"}).transform("translate(0, "+d+")");return c(a,P),P.dragVertical(),this.gQTracks.add(P),this.viewSet.push(M),this.viewSet.push(O),this.viewSet.push(N),this.viewSet.push(m),this.textSet.push(L),P},a.proteinMarkers=function(a,b){var d,e,f,g,h,i,j,k=this.paper.g().attr({id:"gMarkers"}),l={"font-size":"10px","font-family":"Arial","text-anchor":"middle"};for(d=a.length;d--;)e=a[d],e.x&&""!==e.x&&(f="bottom"===e.position?26:0,g=e.type?e.type:"glycan",h=e.label?"m_"+e.label:"m_"+d,i=this.createUse(g,e.x,b+f,{id:h,title:e.label?e.label:g}),e.label&&(f="bottom"===e.position?45:0,j=this.paper.text(e.x,b+f,e.label).attr(l),e.color&&j.attr({fill:e.color}),this.textSet.push(j),k.add(j)),e.color&&i.attr({fill:e.color,stroke:e.color}),c(e,i),k.add(i))},a.proteinBridges=function(a,b){var d,e,f,g,h,i,j,k,l,m,n=this.paper.g().attr({id:"gBridges","class":"pl-bridge"}),o=this.paper,p=12,q={},r={fill:"white",stroke:"white"};for(var s in a){if(d=a[s],e=o.g().attr({id:"bridge_"+s}),c(d,e),q={},d.color&&(q={fill:d.color,stroke:d.color}),f=d.start-.5,g=d.end-.5,h=(g+f)/2,i=o.line(f,b,f,b+p).attr(q),this.viewSet.push(i),j=o.line(g,b,g,b+p).attr(q),this.viewSet.push(j),k=o.line(f,b+p,g,b+p).attr(q),this.viewSet.push(k),d.startlabel&&(l=o.text(f,b+21,d.startlabel),d.color&&l.attr({fill:d.color}),this.textSet.push(l),e.add(l)),d.endlabel){var l=o.text(g,b+21,d.endlabel);d.color&&l.attr({fill:d.color}),this.textSet.push(l),e.add(l)}if(e.add(i,j,k),d.type){l=o.text(h,b+15,d.type);var t=d.type.length;m=o.line(h-t/2-1,b+p,h+t/2+1,b+p).attr(r),d.color&&l.attr({fill:d.color}),l.toFront(),this.textSet.push(l),this.viewSet.push(m),e.add(m,l)}n.add(e)}},a.draw=function(a){var b,c,d,f,g=[],h=a.sequence.toUpperCase().split(""),i=35,j=20,k=this.paper,l=[],m=[];if(a.markers&&this.proteinMarkers(a.markers,j),a.bridges&&this.proteinBridges(a.bridges,i+15),a.overlayfeatures){var n=a.overlayfeatures.showLabels||!1;this.featureTrack(a.overlayfeatures,i-5,20,!0,n,!0)}for(this.aliTop=i,this.proteinSequence(h,i,!0),this.proteinSeqBG(h,g,i,!0,"main"),this.protael.isChrome&&(this.strechSeq=this.paper.text(0,30,a.sequence).attr({id:"strechSeq","font-family":"monospace","font-size":"9px","text-anchor":"start","letter-spacing":"0px"}).hide(),this.strechSeq.attr({uwidth:this.strechSeq.getBBox().width,numspaces:h.length})),i+=30,this.gLabels=this.paper.g().attr({"font-size":"14px","text-anchor":"start",id:"cursor"}).hide(),c=a.ftracks?a.ftracks.length:0,b=0;c>b;b++)d=a.ftracks[b].allowOverlap||!1,f=this.featureTrack(a.ftracks[b],i,e.featureHeight,d,!0),i+=e.featureHeight*f+e.space;for(c=a.qtracks?a.qtracks.length:0,b=0;c>b;b++)if(a.qtracks[b].values&&a.qtracks[b].values.length){this.quantTrack(a.qtracks[b],i,this.protael.W,e.graphHeight);var o=k.rect(0,16+i,22,20,4,4).attr({fill:"#000",stroke:"black",color:"white","stroke-width":"2px",opacity:".7"}),p=k.text(0,30+i,"").attr({fill:"white"});this.gLabels.add(o,p),l[b]=p,m[b]=o,a.qtracks[b].topY=i,i+=e.graphHeight+e.space}else console.log("No values found for QTRACK ["+b+"]. Skipping.");this.aliTop=i;var q=a.alidisplay?!0:!1;if(a.alignments)for(this.protael.setColoringScheme("Original"),c=a.alignments.length,b=0;c>b;b++){var r=a.alignments[b],s=r.sequence.split("");this.proteinSequence(s,i,q,r),i+=10,q&&(i+=5)}this.gSequences.add(this.seqLabelsSet,this.seqBGSet,this.seqChars,this.seqLines),this.labelsWidth=this.seqLabelsSet.getBBox().width,this.seqBGSet.hide(),this.seqChars.hide().transform("T1, 0"),this.gSequences.toFront(),this.seqLines.toBack(),this.gAxes.toBack(),this.selector=k.rect(-1,0,0,this.protael.H).attr({fill:"#DDD",stroke:"#666","stroke-width":"2px",opacity:.5,id:"selector"}).hide(),this.pointer=k.rect(0,0,1,this.protael.H).attr({fill:"green",stroke:"green","stroke-width":"1px",opacity:.7,id:"pointer"}),this.viewSet.push(this.selector);var t=k.rect(0,46,22,20,4,4).attr({fill:"#000",stroke:"black",color:"white","stroke-width":"2px",opacity:.7}),u=k.text(0,60,"").attr({fill:"white"});this.seqLineCovers.toFront();var v=this,w=this.protael,o=k.rect(0,0,w.W,w.H).toBack().attr({stroke:"#fff",opacity:0,id:"blanket"});this.gLabels.add(t,u),k.mousemove(function(b){b=b||window.event;var c,d=b.offsetX,e="#"+w.container+" #blanket",f=5;if(void 0===d){var g=$(e);d=b.pageX-g.offset().left}if(c=Math.round(d+w.currShift),!(0>c)&&(v.pointer.attr({x:c+f}).show(),w.showCursorTooltips)){var i=w.toOriginalX(c);u.node.textContent=h[i]+": "+(i+1),c+=f,v.gLabels.transform("T "+c+" 0").show();var j=u.getBBox().width;t.attr({width:j});for(var g in a.qtracks)if(a.qtracks[g].values&&a.qtracks[g].values.length){var k=l[g],n=m[g];k.node.textContent=a.qtracks[g].values[i];var j=k.getBBox().width;n.attr({width:j})}}}).mouseout(function(){v.gLabels.hide(),v.pointer.hide()}),this.viewSet.push(o)},a.toSVGString=function(){return this.paper.toString()}}(c.prototype),b.Paper=c,b.prototype.Utils={},b.prototype.Utils.calcHeight=function(a){var b=e.mainSeqHeight,c=0;return a.ftracks&&a.ftracks.length&&(b+=e.featureHeight*(a.ftracks.length+2)),a.qtracks&&(b+=(e.graphHeight+e.space)*a.qtracks.length),a.alignments&&(c=a.alidisplay?15:10,b+=c*a.alignments.length),b+20},b.prototype.Utils.splitData=function(a){return a.split(a.indexOf(",")>0?",":"")},b.prototype.Utils.getColors=function(a,b){var c,d=[],e=a.length;for(c=0;e>c;c++)d[c]=b[a[c]]||"white";return d};var g=b.prototype.Utils;return function(a){function b(a){return a&&0==a.lastIndexOf("http",0)&&-1==a.lastIndexOf(window.location.host)}function c(a){for(var c="",d=document.styleSheets,e=0;e<d.length;e++)if(b(d[e].href))console.warn("Cannot include styles from other hosts: "+d[e].href);else{var f=d[e].cssRules;if(null!=f)for(var g=0;g<f.length;g++){var h=f[g];if("undefined"!=typeof h.style){var i=null;try{i=a.querySelector(h.selectorText)}catch(j){console.warn('Invalid CSS selector "'+h.selectorText+'"',j)}if(i){var k=h.selectorText;c+=k+" { "+h.style.cssText+" }\n"}else h.cssText.match(/^@font-face/)&&(c+=h.cssText+"\n")}}}return c}a.draw=function(){return this.paper.draw(this.protein),this.CS||this.setColoringScheme("Original"),this.setZoom(d/this.W),this.clearSelection(),this.initTooltips(),this.initClicks(),this},a.setSelection=function(a,b){this.selectedx[0]=a,this.selectedx[1]=b;var c=this.toScreenX(b)-this.toScreenX(a-1);return this.paper.selector.attr({width:c,x:this.toScreenX(a-1)+this.currShift}).show(),this.controlsEnabled&&this.selectInput.val(a+":"+b),this},a.clearSelection=function(){this.selectedx=[-1,-1],this.paper.selector.attr({x:0,width:0}).hide().toBack(),this.controlsEnabled&&this.selectInput.val("");var a=this.svgDiv.scrollLeft(),b=$("#"+this.container+" .protael_resizable").width(),c=this.toOriginalX(a+b/2);return c>this.W&&(c=this.W/2),this.controlsEnabled&&this.selectSlider.slider("values",[c-1,c+2]),this},a.translate=function(a){return this.svgDiv.scrollLeft(this.svgDiv.scrollLeft()+a),this},a.zoomIn=function(){return this.setZoom(this.currScale+.1),this},a.zoomOut=function(){return this.setZoom(this.currScale-.1),this},a.zoomToFit=function(){var a=this.svgDiv.width();return this.setZoom(a/this.W),this},a.zoomToSelection=function(){if(-1!==this.selectedx[1]){var a=this.selectedx[1]-this.selectedx[0];this.setZoom(this.svgDiv.width()/a-.2);var b=(this.selectedx[0]+a/2)*this.currScale-this.svgDiv.width()/2;return this.svgDiv.scrollLeft(b),this}},a.setPaperWidth=function(a){return this.paper.setWidth(a),this},a.currentScale=function(){return this.currScale},a.getConstruct=function(){if(-1===this.selectedx[0])return"No selection";var a=this.protein.label||"construct";return">"+a+" "+this.selectedx[0]+":"+this.selectedx[1]+"\n"+this.protein.sequence.substring(this.selectedx[0]-1,this.selectedx[1])},a.toOriginalX=function(a){return Math.round((a+this.currShift)/this.currScale)},a.toScreenX=function(a){return Math.round(a*this.currScale-this.currShift)},a.setShowCursorTooltips=function(a){return a||this.paper.gLabels.hide(),this.showCursorTooltips=a,this},a.setZoom=function(a){return a=Math.min(a,15),a=Math.max(a,.5),this.paper.setZoom(a),$("#"+this.container+" .protael_zoomslider").slider("value",this.currScale),this},a.setColoringScheme=function(a){return this.paper.setColoringScheme(a),this.CS=a,this},a.select=function(a){return Snap.selectAll(a)},a.toSVGString=function(){return this.paper.toSVGString()},a.saveAsSVG=function(){var a='<?xml version="1.0" standalone="yes"?>\n<?xml-stylesheet href="http://proteins.burnham.org:8080/Protael/css/protael.css" type="text/css"?>\n<svg xmlns:xlink="http://www.w3.org/1999/xlink" ',b=this.toSVGString(),d=document.getElementById(this.container),e="<style type='text/css'><![CDATA[\n"+c(d)+"\n]]></style>",f=a+" "+b.substring(4,b.length-6)+e+"</svg>",g=new Blob([f],{type:"image/svg+xml"});console.log(e),saveAs(g,"protael_export.svg")},a.addDefinition=function(a,b,c){this.paper.addDef(a,b,c)},a.initTooltips=function(){$(document).tooltip({track:!0,content:function(){var a=$(this);if(a.is("[data-d]")){var b=a.data("d"),c="<table>";for(var d in b)c+="pdbid"===d?'<tr><td colspan="2"><img src="http://www.rcsb.org/pdb/images/'+b[d]+'_bio_r_250.jpg"></td></tr>':"<tr><td>"+d+":</td><td>"+b[d]+"</td></tr>";return c+="</table>"}return a.is("[title]")?a.attr("title"):a.is("img")?a.attr("alt"):void 0}})},a.initClicks=function(){$("[data-x]").click(function(){var a=$(this),b=a.data("x");if(Object.keys(b).length>0){var c="<table>";for(var d in b)c+="<tr><td>"+d+':</td><td><a target="_blank" href="'+b[d]+'">'+b[d]+"</a</td></tr>";c+="</table>",$("#propsdialog").html(c),$("#propsdialog").dialog("open")}})}}(b.prototype),window.Protael=b,b}();